# CausalViz
CausalVizæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å› æœæ¨æ–­å’Œå¯è§†åŒ–å·¥å…·åŒ…ï¼Œå®ƒèƒ½å¸®åŠ©ç ”ç©¶è€…å¿«é€Ÿæ„å»ºç¥ç»ç½‘ç»œæ¨¡å‹ã€åˆ†æå˜é‡é—´çš„å› æœå…³ç³»ï¼Œå¹¶æä¾›ç›´è§‚çš„å¯è§†åŒ–ç»“æœã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§
- ğŸ”¨ **è‡ªåŠ¨åŒ–å»ºæ¨¡** - åŸºäºç¥ç»ç½‘ç»œçš„å¤šå˜é‡æ‹Ÿåˆï¼Œè‡ªåŠ¨ä¿å­˜æ‹Ÿåˆç»“æœ
  ğŸ“Š **å› æœæ•ˆåº”åˆ†æ** - ä¸€é”®è®¡ç®—å’Œå¯è§†åŒ–ä»»æ„å˜é‡çš„å¹³å‡å› æœæ•ˆåº”
  ğŸ¯ **è°ƒèŠ‚æ•ˆåº”åˆ†æ** - æ™ºèƒ½è¯†åˆ«å’Œé‡åŒ–å˜é‡é—´çš„è°ƒèŠ‚ä½œç”¨
  ğŸ“ˆ **ç»Ÿè®¡æ£€éªŒ** - é›†æˆä¼¼ç„¶æ¯”æ£€éªŒï¼Œæä¾›ä¸¥è°¨çš„ç»Ÿè®¡æ˜¾è‘—æ€§åˆ†æ
  ğŸ–¼ï¸ **å¯è§†åŒ–æ”¯æŒ** - è‡ªåŠ¨ç”Ÿæˆæ¸…æ™°ç›´è§‚çš„åˆ†æå›¾è¡¨

## ğŸ” åŠŸèƒ½è¯¦è§£
### 1. ç¥ç»ç½‘ç»œå»ºæ¨¡ä¸æ‹Ÿåˆ
åŸºäºpytorchæœºå™¨å­¦ä¹ æ¡†æ¶ï¼Œæ”¯æŒä½¿ç”¨å¤šä¸ªè‡ªå˜é‡X(xâ‚, xâ‚‚, xâ‚ƒ, ..., xâ‚™)å¯¹å› å˜é‡yè¿›è¡Œå¤šæ¬¡æ‹Ÿåˆå»ºæ¨¡ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜æ‰€æœ‰æ‹Ÿåˆç»“æœï¼Œä¸ºåç»­åˆ†ææä¾›å¯é çš„æ•°æ®åŸºç¡€ã€‚
### 2. å¹³å‡æ•ˆåº”åˆ†æ
ä¸€é”®é€‰æ‹©ä»»æ„è‡ªå˜é‡xâ‚–ï¼Œå¿«é€Ÿè·å–å…¶å¯¹å› å˜é‡yçš„å¹³å‡æ•ˆåº”æ‹Ÿåˆç»“æœã€‚åŒæ—¶é›†æˆä¼¼ç„¶æ¯”æ£€éªŒåŠŸèƒ½ï¼Œå¯è‡ªåŠ¨åˆ†ææ•ˆåº”æ›²çº¿å„æ®µçš„ç»Ÿè®¡æ˜¾è‘—æ€§ï¼Œå¸®åŠ©ç ”ç©¶è€…å‡†ç¡®åˆ¤æ–­æ¯ä¸€æ®µå˜é‡é—´çš„å› æœå…³ç³»å¼ºåº¦ã€‚
### 3. äº¤äº’æ•ˆåº”æ™ºèƒ½åˆ†æ
è®¡ç®—å…¶ä»–è‡ªå˜é‡å¯¹ç›®æ ‡å˜é‡xâ‚–çš„è°ƒèŠ‚æ•ˆåº”å¤§å°ï¼Œå¹¶é€šè¿‡æ¨èæœ€å€¼å¾—å…³æ³¨çš„åˆ†ææ–¹å‘ï¼Œå¸®åŠ©ç ”ç©¶è€…å¿«é€Ÿå‘ç°é‡è¦çš„å˜é‡äº¤äº’ä½œç”¨ã€‚
### 4. è°ƒèŠ‚æ•ˆåº”å¯è§†åŒ–
æŒ‡å®šä»»æ„æ§åˆ¶å˜é‡x_cï¼Œä¸€é”®ç”Ÿæˆå…¶å¯¹ç›®æ ‡å˜é‡xâ‚–çš„è°ƒèŠ‚æ•ˆåº”åˆ†æå›¾è¡¨ã€‚åŒæ—¶æä¾›å…¨å±€è°ƒèŠ‚æ•ˆåº”çš„ä¼¼ç„¶æ¯”æ£€éªŒç»“æœï¼Œç›´è§‚å±•ç¤ºæ§åˆ¶å˜é‡çš„è°ƒèŠ‚ä½œç”¨åŠå…¶ç»Ÿè®¡æ˜¾è‘—æ€§ã€‚

## ğŸ¨ æ•ˆæœå±•ç¤º
### ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
```python
n_samples = 5000  # æ ·æœ¬é‡
x1 = np.random.normal(0, 10, n_samples)      # ç”Ÿæˆå‡å€¼ä¸º0,æ ‡å‡†å·®ä¸º10çš„æ­£æ€åˆ†å¸ƒ
x2 = np.random.uniform(-10, 10, n_samples)   # ç”Ÿæˆ[-10,10]åŒºé—´çš„å‡åŒ€åˆ†å¸ƒ
x3 = np.random.normal(0, 10, n_samples)      # ç”Ÿæˆå‡å€¼ä¸º0,æ ‡å‡†å·®ä¸º10çš„æ­£æ€åˆ†å¸ƒ
x4 = np.random.uniform(-10, 10, n_samples)   # ç”Ÿæˆ[-10,10]åŒºé—´çš„å‡åŒ€åˆ†å¸ƒ
x5 = np.random.normal(-3, 1.5, n_samples)    # ç”Ÿæˆå‡å€¼ä¸º-3,æ ‡å‡†å·®ä¸º1.5çš„æ­£æ€åˆ†å¸ƒ
x8 = np.random.normal(0, 10, n_samples)      # ç”Ÿæˆå‡å€¼ä¸º0,æ ‡å‡†å·®ä¸º10çš„æ­£æ€åˆ†å¸ƒ
# ç”Ÿæˆç›¸å…³å˜é‡
x6 = x4 * 2                                  # x6ä¸x4å‘ˆçº¿æ€§ç›¸å…³
x7 = x5 * 2 + np.random.normal(0, 0.3, n_samples)  # x7ä¸x5å‘ˆçº¿æ€§ç›¸å…³,åŠ å…¥éšæœºå™ªå£°
median_x4 = np.median(x4)                    # è®¡ç®—x4çš„ä¸­ä½æ•°
mask = x4 <= median_x4                       # åˆ›å»ºæ©ç ,æ ‡è®°å°äºç­‰äºä¸­ä½æ•°çš„ç‚¹
x4_new = np.random.uniform(-10, 0, int(n_samples/2))  # ç”Ÿæˆæ–°çš„å‡åŒ€åˆ†å¸ƒæ•°æ®
x4[mask] = x4_new                           # æ›¿æ¢x4ä¸­è¾ƒå°çš„ä¸€åŠæ•°æ®ç‚¹
# æ·»åŠ éšæœºå™ªå£°
noise = np.random.normal(0, 5, n_samples)    # ç”Ÿæˆéšæœºå™ªå£°
# ç”Ÿæˆå› å˜é‡y,åŒ…å«å¤æ‚çš„éçº¿æ€§å…³ç³»å’Œäº¤äº’æ•ˆåº”
y = (x3+10)/20*10*x1 + (10-x3)/20*x1**2 + (x2/2)**2 + (x4/2)**2 + 2*x5 + x6 + x7 + 2*x8 + noise
```
### 1. å¹³å‡å› æœæ•ˆåº”ç¤ºä¾‹å›¾

![å¹³å‡å› æœæ•ˆåº”åˆ†æ](https://github.com/user-attachments/assets/54b207b6-42a5-405f-9a4a-0e30f30ad007)

å›¾1ä¸­å…ƒç´ å«ä¹‰ï¼š
- æ•£ç‚¹åæ ‡ï¼šæ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªæ ·æœ¬çš„[x1,y]å€¼
- è“è‰²çƒ­åŠ›å›¾ï¼šè¡¨ç¤ºæ‹Ÿåˆç©ºé—´åœ¨y-x1å¹³é¢çš„æŠ•å½±åˆ†å¸ƒ
- çº¢è‰²æ›²çº¿ï¼šå±•ç¤ºx1å¯¹yçš„å¹³å‡å› æœæ•ˆåº”
            æ›²çº¿ç²—ç»†åæ˜ é™„è¿‘æ•£ç‚¹å¯†åº¦ï¼Œæ•£ç‚¹è¶Šå°‘æ›²çº¿è¶Šç»†ï¼Œè¡¨ç¤ºè¯¥åŒºåŸŸçš„æ‹Ÿåˆç»“æœè¶Šä¸ç¨³å¥

å›¾2ä¸­å…ƒç´ å«ä¹‰ï¼š
- çº¢-è“æ›²çº¿ï¼šå±•ç¤ºx1å¯¹yçš„å¹³å‡å› æœæ•ˆåº”
            æ›²çº¿é¢œè‰²ä»è“åˆ°çº¢è¡¨ç¤º å¼¯æŠ˜æŒ‡æ•° çš„å¤§å°ï¼Œè¶Šçº¢è¡¨ç¤ºå¼¯æŠ˜è¶Šæ˜¾è‘—
            å¼¯æŠ˜æŒ‡æ•° = è¯¥ç‚¹å¼¯æŠ˜çš„æ¦‚ç‡å¯†åº¦ Ã— è¯¥ç‚¹å¼¯æŠ˜çš„å¹…åº¦ï¼Œç”¨äºé‡åŒ–æ¯ä¸ªç‚¹å¤„å¼¯æŠ˜çš„æ˜¾è‘—ç¨‹åº¦
            å¼¯æŠ˜æŒ‡æ•°è¾ƒå¤§çš„ç‚¹å¯èƒ½ä»£è¡¨é‡è¦çš„é—¨é™å€¼ï¼Œæ˜¯å˜é‡å…³ç³»å‘ç”Ÿæ˜¾è‘—å˜åŒ–çš„ä½ç½®
- é»„è‰²æ›²çº¿ï¼šå±•ç¤ºç¥ç»ç½‘ç»œåœ¨å„ç‚¹å¤„å‡ºç°å¼¯æŠ˜çš„æ¦‚ç‡å¯†åº¦

å›¾3ä¸­å…ƒç´ å«ä¹‰ï¼š
- æ•£ç‚¹åæ ‡ï¼šæ¯ä¸ªç‚¹ä»£è¡¨ä¸€ä¸ªæ ·æœ¬çš„[x1,y_pred+residual]å€¼
- çº¢è‰²æ›²çº¿ï¼šå±•ç¤ºx1å¯¹yçš„å¹³å‡å› æœæ•ˆåº”
            å¼€å¯è®¡ç®—LRTç»Ÿè®¡é‡åå¯ä»¥è®¡ç®—æ¯ä¸€æ®µçš„æ–œç‡åŠå…¶æ˜¾è‘—æ€§
- ç°è‰²æ›²çº¿ï¼šè¡¨ç¤ºæ®‹å·®éšx1å˜åŒ–çš„èµ°åŠ¿ï¼ˆå±€éƒ¨æ®‹å·®/æ€»ä½“æ®‹å·®ï¼‰
ä¸‹å›¾ä¸ºå¼€å¯è®¡ç®—LRTç»Ÿè®¡é‡åçš„æ•ˆæœï¼š
![å¹³å‡å› æœæ•ˆåº”åˆ†æï¼šå¼€å¯LRTç»Ÿè®¡é‡è®¡ç®—](https://github.com/user-attachments/assets/b696642d-0441-46cb-8680-55e3a16941ef)

### 2. è°ƒèŠ‚æ•ˆåº”ï¼ˆäº¤äº’æ•ˆåº”ï¼‰æŒ‡æ•°åˆ†æ

![è°ƒèŠ‚æ•ˆåº”ï¼ˆäº¤äº’æ•ˆåº”ï¼‰æŒ‡æ•°åˆ†æ](https://github.com/user-attachments/assets/5729d300-1776-4ea6-919b-fff3a007557e)

è¯¥æŒ‡æ•°å·²å½’ä¸€åŒ–å¤„ç†ï¼Œå–å€¼èŒƒå›´ä¸º[0,1]ï¼Œå–å€¼è¶Šå¤§è¡¨ç¤ºè°ƒèŠ‚æ•ˆåº”è¶Šæ˜¾è‘—
å¯ä»¥çœ‹åˆ°x3å¯¹x1çš„è°ƒèŠ‚æ•ˆåº”æœ€å¤§ï¼Œç¬¦åˆæˆ‘ä»¬æ•°æ®çš„ç”Ÿæˆè¿‡ç¨‹

### 3. è°ƒèŠ‚æ•ˆåº”ï¼ˆäº¤äº’æ•ˆåº”ï¼‰å¯è§†åŒ–

![è°ƒèŠ‚æ•ˆåº”ï¼ˆäº¤äº’æ•ˆåº”ï¼‰å¯è§†åŒ–](https://github.com/user-attachments/assets/2bcdd537-32e3-4e9d-929c-6a3cd88c623c)

å›¾ä¸­å…ƒç´ å«ä¹‰ï¼š
- è¯¥å›¾å›ºå®šç”»å‡ºäº”æ¡æ›²çº¿ï¼Œè¡¨ç¤ºx3åœ¨ä¸åŒå–å€¼çš„æƒ…å†µä¸‹ï¼Œx1å¯¹yçš„å¹³å‡å› æœæ•ˆåº”
åŒæ—¶è¯¥å›¾æ”¯æŒè®¡ç®—LRTç»Ÿè®¡é‡ï¼Œæä¾›x3å¯¹x1çš„è°ƒèŠ‚æ•ˆåº”çš„å…¨å±€æ£€éªŒï¼Œä¸‹å›¾ä¸ºå¼€å¯LRTç»Ÿè®¡é‡è®¡ç®—åçš„æ•ˆæœï¼š

![è°ƒèŠ‚æ•ˆåº”ï¼ˆäº¤äº’æ•ˆåº”ï¼‰å¯è§†åŒ–ï¼šå¼€å¯LRTç»Ÿè®¡é‡](https://github.com/user-attachments/assets/abe93ea0-6591-4e82-9b18-e54fcdd53097)

å¯¹æ¯”ï¼šx4å¯¹x1çš„è°ƒèŠ‚æ•ˆåº”æ˜¾è‘—æ€§æ£€éªŒ

![x4å¯¹x1çš„è°ƒèŠ‚æ•ˆåº”æ˜¾è‘—æ€§æ£€éªŒ](https://github.com/user-attachments/assets/ce737f07-a273-4a54-b1f8-4eafa3a306dc)


æ ¹æ®æ•°æ®çš„ç”Ÿæˆè¿‡ç¨‹å¯çŸ¥ï¼Œx4å¯¹x1çš„è°ƒèŠ‚æ•ˆåº”ä¸æ˜¾è‘—ï¼Œç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Python >= 3.7
 PyTorch >= 1.8.0
 NumPy >= 1.19.2
 Pandas >= 1.2.3
 Matplotlib >= 3.3.4
### å®‰è£…æ–¹æ³•
pip install CausalViz
### ä½¿ç”¨æ–¹æ³•
```python
from CausalViz import CausalVisualizer

visualizer = CausalVisualizer()

visualizer.load_data(df,y_col='y')

visualizer.NN_singlefit(n=30,
    epochs=5000,
    learning_rate=0.1,
    min_lr=0.01,
    switch_threshold=0.01,
    patience=1000,
    min_delta=1e-7,
    decay_rate=[0.8, 50],
    penalty_strength=1)

multi_fit_result = visualizer.NN_multifit(25,
    trials=10,
    epochs=2000,
    learning_rate=0.1,
    min_lr=0.01,
    switch_threshold=0.01,
    patience=1000,
    min_delta=1e-7,
    decay_rate=[0.8, 50],
    penalty_strength=1,
    pop_ratio=0.5)

visualizer.plot_average_effects(multi_fit_result,
    x_name='x1',
    k=5000,
    caculate_significance=True,
    train_control_model_setting=[5, 1000, 0.1, [0.9, 50], 0.5],
    bboxtoanchor2=(0.5, 0.9),
    bboxtoanchor3=(0.5, 0.6))

visualizer.analyze_moderation_effect(multi_fit_result,
    x_name='x1',
    )
    
visualizer.plot_moderation_effect(multi_fit_result,
    main_x_name='x1',
    control_x_name='x4',
    caculate_moderation_LRT=True,
    train_control_model_setting=[5, 2000, 0.1, 0.01, 0.01, 1000, 1e-7, [0.8, 50], 0.5]
)
```





